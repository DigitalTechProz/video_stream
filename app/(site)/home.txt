import React from 'react';
import { createClient } from 'contentful';
import { Movie, MovieSkeleton, MovieFields } from '../types/movie';
import { Entry } from 'contentful';
import MovieList from '../components/MovieList';

export default async function Home() {
  const client = createClient({
    space: process.env.NEXT_PUBLIC_CONTENTFUL_SPACE_ID!,
    accessToken: process.env.NEXT_PUBLIC_CONTENTFUL_ACCESS_TOKEN!,
  });

  let movies: Movie[] = [];

  try {
    const res = await client.getEntries<MovieSkeleton>({ content_type: 'movie' });

    movies = res.items.map((item: Entry<MovieSkeleton>) => {
      const fields = item.fields as MovieFields;

      return {
        title: fields.title || '',
        description: fields.description,
        apiVideoId: fields.apiVideoId || '',
        duration: fields.duration,
        tags: fields.tags || [],
        uploadDate: fields.uploadDate || '',
        thumbnail: fields.thumbnail && fields.thumbnail.fields?.file
          ? { 
              url: typeof fields.thumbnail.fields.file.url === 'string' ? fields.thumbnail.fields.file.url : '',
              title: typeof fields.thumbnail.fields.title === 'string' ? fields.thumbnail.fields.title : ''
            }
          : undefined,
        categories: fields.categories?.map(category => {
          const categoryFields = category.fields as { name: string; description?: string };
          return {
            name: typeof categoryFields.name === 'string' ? categoryFields.name : '',
            description: typeof categoryFields.description === 'string' ? categoryFields.description : undefined
          };
        }) || []
      };
    }) as Movie[];
  } catch (error) {
    console.error('Error fetching movies:', error);
  }

  return (
    <main className='bg-background-black text-white min-h-screen'>
      <MovieList movies={movies} />
    </main>
  );
}
